<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>USOTOREスマホ版</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0a0a0a;--panel:#0f0f10;--text:#f3f4f6;--win:#22c55e;--lose:#ef4444;--gold:#fbbf24;--cyan:#38bdf8;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);color:var(--text);font-family:"Rajdhani","Noto Sans JP",sans-serif;overflow:hidden;}
  #chart{width:100vw;height:60vh;background:#0b0b10;}
  #title{text-align:center;font-size:24px;letter-spacing:6px;padding:12px 0;color:rgba(251,191,36,0.88);text-shadow:0 0 16px rgba(251,191,36,0.40);}
  .pill{position:absolute;right:12px;top:40px;background:#0009;border:1px solid #374151;padding:4px 10px;border-radius:10px;font-size:13px}
  #controls{
    position:fixed;bottom:0;left:0;width:100%;background:rgba(15,15,16,.92);
    display:flex;gap:6px;padding:8px;z-index:9999;
  }
  button{
    flex:1;padding:13px;border:none;border-radius:10px;font-size:18px;font-weight:700;color:#fff;
  }
  .btnH{background:linear-gradient(90deg,#16a34a,#22c55e);}
  .btnL{background:linear-gradient(90deg,#ef4444,#f43f5e);}
  .btnHist{background:linear-gradient(90deg,#3b82f6,#60a5fa);}
  #historyPanel{
    position:fixed;bottom:0;left:0;width:100%;height:40vh;background:#0a0a0a;border-top:2px solid #334155;
    transform:translateY(100%);transition:transform .25s ease-out;z-index:9000;padding:8px;overflow-y:auto;font-size:14px;
  }
  #historyPanel.show{transform:translateY(0);}
  .history-entry{border-bottom:1px solid #334155;padding:6px 0;line-height:1.4;}
  .history-entry.win{color:rgba(34,197,94,.85);}
  .history-entry.lose{color:rgba(239,68,68,.85);}
</style>
</head>

<body>

<div id="title">ＵＳＯＴＯＲＥ</div>
<div id="rateText" class="pill">---</div>
<canvas id="chart"></canvas>

<!-- 履歴 -->
<div id="historyPanel"></div>

<!-- 固定ボタン -->
<div id="controls">
  <button class="btnH" onclick="enter('HIGH')">HIGH ↑</button>
  <button class="btnL" onclick="enter('LOW')">LOW ↓</button>
  <button class="btnHist" onclick="toggleHistory()">履歴</button>
</div>

<script>
const cvs=document.getElementById('chart'),ctx=cvs.getContext('2d');
function resize(){cvs.width=innerWidth;cvs.height=innerHeight*0.6;}
addEventListener('resize',resize);resize();

let rate=150.000,balance=1000000,payout=1.8,stake=1000,candles=[],tickets=[],volBase=0.004,last=performance.now();
const baseVisible=90;

// 初期データ
for(let i=0;i<200;i++){ const prev=i?candles[i-1].c:rate;
  const c=+(prev*(1+(Math.random()-0.5)*volBase)).toFixed(3);
  const spread=Math.abs(c-prev)*0.6+0.005;
  candles.push({o:prev,h:Math.max(prev,c)+spread,l:Math.min(prev,c)-spread,c});
  rate=c;
}

function getExpirySeconds(){return 60;} // 判定時間：1分固定（必要に応じて変更可）

let id=1;
function enter(dir){
  const sec=getExpirySeconds();
  tickets.push({id:id++,dir,entry:rate,expiry:sec,end:Date.now()+sec*1000,state:'pending'});
  render();
}

// 更新処理
function step(){rate = +(rate* (1+(Math.random()-0.5)*volBase)).toFixed(3);}
function push(){
  const o=candles.length?candles[candles.length-1].c:rate;
  step(); const c=rate;
  const spread=Math.abs(c-o)*0.6+0.005;
  candles.push({o,h:Math.max(o,c)+spread,l:Math.min(o,c)-spread,c});
  if(candles.length>400) candles.shift();
}

// 決済 & 履歴
const historyPanel=document.getElementById("historyPanel");
function addHistory(entry){
  const div=document.createElement('div');
  div.classList.add('history-entry');
  if(entry.state==='win') div.classList.add('win');
  if(entry.state==='lose') div.classList.add('lose');
  div.innerHTML=`
    <strong>${entry.dir}</strong> @ ${entry.entry.toFixed(3)}<br>
    結果：${entry.state.toUpperCase()}<br>
    判定時刻：${new Date(entry.end).toLocaleTimeString()}
  `;
  historyPanel.prepend(div);
}

function settle(){
  const now=Date.now();
  for(const t of tickets){
    if(t.state==='pending'&&now>=t.end){
      const win=t.dir==='HIGH'?(rate>t.entry):(rate<t.entry);
      t.state=win?'win':'lose';balance+=win?Math.round(stake*(payout-1)):-stake;
      addHistory(t);
    }
  }
}

function render(){
  const w=cvs.width,h=cvs.height;
  ctx.clearRect(0,0,w,h);

  const total=candles.length;
  const visible=Math.min(total,baseVisible);
  const start=total-visible;
  const slice=candles.slice(start);

  const highs=slice.map(c=>c.h),lows=slice.map(c=>c.l);
  const vmin=Math.min(...lows),vmax=Math.max(...highs);

  const x=i=>20+i*(w-40)/(visible-1);
  const y=v=>h - (v-vmin)/(vmax-vmin+1e-9)*h;
  const barW=(w-40)/visible*0.6;

  slice.forEach((c,i)=>{
    const X=x(i),yo=y(c.o),yc=y(c.c),yh=y(c.h),yl=y(c.l);
    const up=c.c>=c.o;
    ctx.strokeStyle=up?'rgba(34,197,94,0.90)':'rgba(239,68,68,0.90)';
    ctx.beginPath(); ctx.moveTo(X,yh); ctx.lineTo(X,yl); ctx.stroke();
    ctx.fillStyle=up?'rgba(34,197,94,0.35)':'rgba(239,68,68,0.35)';
    const top=Math.min(yo,yc),bot=Math.max(yo,yc),hh=Math.max(2,bot-top);
    ctx.fillRect(X-barW/2,top,barW,hh);ctx.strokeRect(X-barW/2,top,barW,hh);
  });

  const curX=x(slice.length-1),curY=y(rate);
  ctx.strokeStyle='rgba(251,191,36,0.6)';ctx.beginPath();ctx.moveTo(curX,0);ctx.lineTo(curX,h);ctx.stroke();

  for(const t of tickets){
    if(t.state==='pending'){
      const yy=y(t.entry);
      ctx.setLineDash([6,6]);
      ctx.strokeStyle=(t.dir==='HIGH')?'rgba(34,197,94,0.95)':'rgba(239,68,68,0.95)';
      ctx.beginPath();ctx.moveTo(20,yy);ctx.lineTo(w-20,yy);ctx.stroke();
      ctx.setLineDash([]);
    }
  }

  document.getElementById('rateText').textContent=rate.toFixed(3);
}

function loop(ts){
  if(ts-last>=1000){
    last=ts;push();settle();render();
  }
  requestAnimationFrame(loop);
}
render();requestAnimationFrame(loop);

// 履歴表示切替
function toggleHistory(){
  historyPanel.classList.toggle('show');
}
</script>

</body>
</html>
